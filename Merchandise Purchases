--BEGIN;

INSERT INTO custom.bse_big_table (
      fan_id
    , salesforce_contact_id
    , cust_action_id
    , action_email
    , first_known_action
    , action_phone
    , cust_action_source_system
    , cust_action
    , cust_action_date
    , cust_action_category
    , product_category
    , merch_category
    , season
    , fiscal_year
    , product_name
    , product_cost
    , action_quantity
    , purchase_price
    , property
)
with audience as (
SELECT
      a.fan_id__pc                           AS fan_id
    , a.id                                    AS salesforce_contact_id
    , f.order_id                                        AS cust_action_id
    , f.client_email                                  AS action_email
    , f.order_date                            AS first_known_action
    , f.ship_address_tel as action_phone
    , 'Fanatics'                                  AS cust_action_source_system
    , 'Merchandise Purchase'                           AS cust_action
    , f.order_date                            AS cust_action_date
    , f.product_category                         AS cust_action_category
    , f.product_category 							as product_category
    , concat(f.product_category, '-', f.product_sub_category)							as merch_category
    
    , CASE
          WHEN EXTRACT(MONTH FROM f.order_date) >= 7
              THEN CONCAT(EXTRACT(YEAR FROM f.order_date)::int, '-', (EXTRACT(YEAR FROM f.order_date)::int + 1))
          ELSE CONCAT((EXTRACT(YEAR FROM f.order_date)::int - 1), '-', EXTRACT(YEAR FROM f.order_date)::int)
      END                                           AS season
    , CASE
          WHEN EXTRACT(MONTH FROM f.order_date) >= 7
              THEN CONCAT(EXTRACT(YEAR FROM f.order_date)::int, '-', (EXTRACT(YEAR FROM f.order_date)::int + 1))
          ELSE CONCAT((EXTRACT(YEAR FROM f.order_date)::int - 1), '-', EXTRACT(YEAR FROM f.order_date)::int)
      END                                           AS fiscal_year
    , left(f.product_name,100)                                      AS product_name
    , f.unit_price 									as product_cost
    , f.qty_sold                                             AS action_quantity
    , (f.unit_price * f.qty_sold)					as purchase_price
    , CASE
          WHEN f.team ilike '%Nets%' then 'Brooklyn Nets'
          when f.team ilike '%WNBA%' then 'New York Liberty'
          when f.team ilike '%Lib%' then  'New York Liberty'
          when f.team ilike '%NBA%' then 'NBA'
          else 'Other'
      END                                           AS property
FROM fanatics.merchandise f
left join fdp.fan f2
	on text(coalesce(f2.email1,f2.email2)) = text(f.client_email)
		and text(f2.systemnames) ilike '%fanatics%'
--left join fdp.email e
	--on f.client_email = e.email  
		--and e.systemname = 'fanatics'
--left join fdp.phone p
	--on p.fanid = e.fanid
left join sfsc.account a
	on a.fan_id__pc = f2.fanid

--ROLLBACK;
